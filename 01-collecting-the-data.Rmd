# Collecting the Data

First things first, we need to acquire yearly datasets of crashes from the ARIES repository. They let you do get data either by downloading csv files or by querying their API. I started with the API first, but ran into trouble when certain years wouldn't respond to my queries. I found that these same datasets would [return an error message](https://i.postimg.cc/wvxV7W9b/ARIES-server-not-responding.png) when trying to preview on the repository as well. Here we will take the approach of downloading all the datasets to disk as csv files before working with them.

Start by loading the needed R libraries.

```{r eval=FALSE}
library(readr) # "The goal of 'readr' is to provide a fast and friendly way to read rectangular data (like 'csv', 'tsv', and 'fwf')."
library(dplyr) # "A fast, consistent tool for working with data frame like objects, both in memory and out of memory.
library(lubridate) # Lubridate makes it easier to do the things R does with date-times and possible to do the things R does not.
library(DBI) # A database interface definition for communication between R and relational database management systems.
library(disk.frame) #[M]anipulate tabular data that doesnâ€™t fit into Random Access Memory
```

## Download the yearly datasets

```{r eval=FALSE}

# Here is a vector of URL's for each year's repository of data
urls <- c(
    "https://hub.mph.in.gov/dataset/4ac55064-1f0d-4e5e-aeee-12faf28d6175/resource/994487c5-5d44-4fb9-ae9d-84ca75659bf0/download/aries_crash_data_2007.csv",
    "https://hub.mph.in.gov/dataset/4ac55064-1f0d-4e5e-aeee-12faf28d6175/resource/e4e56445-8cb6-4fc5-955c-7a2331684279/download/aries_crash_data_2008.csv",
    "https://hub.mph.in.gov/dataset/4ac55064-1f0d-4e5e-aeee-12faf28d6175/resource/881391be-d712-44b4-bfd0-ef9f018a4e4b/download/aries_crash_data_2009.csv",
    "https://hub.mph.in.gov/dataset/4ac55064-1f0d-4e5e-aeee-12faf28d6175/resource/46eb8985-f5b5-4635-9d6c-769dbd05fa02/download/aries_crash_data_2010.csv",
    "https://hub.mph.in.gov/dataset/4ac55064-1f0d-4e5e-aeee-12faf28d6175/resource/32ecfbfa-cf4b-4f64-af48-e1a624ae5ba4/download/aries_crash_data_2011.csv",
    "https://hub.mph.in.gov/dataset/4ac55064-1f0d-4e5e-aeee-12faf28d6175/resource/c2727405-925d-48fe-a8c1-06058ee65a25/download/aries_crash_data_2012.csv",
    "https://hub.mph.in.gov/dataset/4ac55064-1f0d-4e5e-aeee-12faf28d6175/resource/ca9adbd5-001e-49e7-a850-f9f3471eb2db/download/aries_crash_data_2013.csv",
    "https://hub.mph.in.gov/dataset/4ac55064-1f0d-4e5e-aeee-12faf28d6175/resource/a5262209-109c-49cd-b6a9-a72970dc1cf5/download/aries_crash_data_2014.csv",
    "https://hub.mph.in.gov/dataset/4ac55064-1f0d-4e5e-aeee-12faf28d6175/resource/7fd801c4-4cf3-4e18-a949-a4d21401d798/download/aries_crash_data_2015.csv",
    "https://hub.mph.in.gov/dataset/4ac55064-1f0d-4e5e-aeee-12faf28d6175/resource/88646815-5b52-433b-9609-c75500e48e4c/download/aries_crash_data_2016.csv",
    "https://hub.mph.in.gov/dataset/4ac55064-1f0d-4e5e-aeee-12faf28d6175/resource/911880b1-d0bb-4168-a5c1-a52dcc291445/download/aries_crash_data_2017.csv",
    "https://hub.mph.in.gov/dataset/4ac55064-1f0d-4e5e-aeee-12faf28d6175/resource/cc90589c-72d8-4d92-a5fe-73254b555c73/download/aries_crash_data_2018.csv",
    "https://hub.mph.in.gov/dataset/4ac55064-1f0d-4e5e-aeee-12faf28d6175/resource/7081439e-33c9-45f5-9c0b-86d8a8c49252/download/aries_crash_data_2019.csv"
)

# Make a new folder for the data files
system("mkdir raw-ARIES")

# Make a reference vector of years for the datasets
years <- 2007:2019

# Download the CSV files
for (i in 1:13) {
    download.file(url = urls[i], destfile = paste0("raw-ARIES/aries-crash-data-",years[i],".csv"))
}
```

## Instruct R on how to parse the datasets

CSV files are in a simple-text spreadsheet format. They don't give much contextual information. For example, R needs to know what kind of variable each column corresponds to. Normally it can infer the type on its own. But we have so much missing data in these files, R hiccups when trying to assign a type. The next block of code walks through how to manually type each column.

You may notice that we are telling R to skip many of the columns it will encounter. This is because these columns are duplicates that store the same information in different formats. We will only keep one of the respective columns when these situations arise.

```{r}
# Need to modify how dates are read in

# Tell the read_csv function which columns to keep and how to parse them 
columnParsing <- c(INDEXING_NUMBER = "numeric",
                       INDIVIDUAL_MR_RECORD = "numeric",
                       UNIT_MR_NUMBER = "numeric",
                       STATUSCDE = "numeric",
                       PERSONNMB = "numeric",
                       PERSONTYPECDE = "NULL",
                       PERSONTYPEDESCR = "character",
                       GENDERCDE = "character",
                       AGE_GRP = "character",
                       POSINVEHCDE = "NULL",
                       POSINVEHDESCR = "character",
                       EJECTTRAPCDE = "NULL",
                       EJECTTRAPDESCR = "character",
                       SAFETYEQUUSEDCDE = "NULL",
                       SAFETYEQUUSEDDESCR = "character",
                       SAFETYEQUEFFIND = "character",
                       INJSTATUSCDE = "NULL",
                       INJSTATUSDESCR = "character",
                       INJNATURECDE = "NULL",
                       INJNATUREDESCR = "character",
                       INJLOCCDE = "NULL",
                       INJLOCCDESCR = "character",
                       TESTGIVENCDE = "NULL",
                       TESTGIVENDESCR = "character",
                       RESULTALCHTXT = "numeric",
                       RESULTDRUGIND = "character",
                       AGENCYORITXT = "NULL",
                       AGENCYORIDESCR = "character",
                       COUNTYCDE = "NULL",
                       COUNTY_STATE = "NULL",
                       COUNTYDESCR = "character",
                       CITYCDE = "NULL",
                       CITYDESCR = "character",
                       COLLDTE = "character",
                       COLLISION_DAY = "character",
                       COLLISION_MONTH = "character",
                       COLLISION_YEAR = "numeric",
                       COLLISION_TIME = "character",
                       COLLISION_TIME_AM_PM = "character",
                       MOTORVEHINVOLVEDNMB = "numeric",
                       TRAILERSINVOLVEDNMB = "numeric",
                       INJUREDNMB = "numeric",
                       DEADNMB = "numeric",
                       DEERNMB = "numeric",
                       RDWYSUFFIXTXT = "character",
                       RDWYRAMPTXT = "character",
                       INTERINTERCHANGETXT = "character",
                       INCORPLIMITIND = "character",
                       PROPDAMAGECDE = "NULL",
                       PROPDAMAGEDESCR = "character",
                       LATDECIMALNMB = "numeric",
                       LONGDECIMALNMB = "numeric",
                       TRAFFICCNTLOPIND = "character",
                       AGGRESSIVEDRIVEIND = "character",
                       HITRUNIND = "character",
                       SCHOOLZONEIND = "character",
                       RUMBLESTRIPIND = "character",
                       CONSTRUCTIND = "character",
                       LIGHTCONDCDE = "NULL",
                       LIGHTCONDDESCR = "character",
                       WEATHERCDE = "NULL",
                       WEATHERDESCR = "character",
                       SURFACETYPECDE_CONDDESCR = "character",
                       SURFACETYPECDE = "NULL",
                       SURFACETYPEDESCR = "character",
                       PRIMARYFACTORCDE = "NULL",
                       PRIMARYFACTORDESCR = "character",
                       MANNERCOLLCDE = "NULL",
                       MANNERCOLLDESCR = "character",
                       TIMENOTIFIEDTXT = "character",
                       TIMENOTIFIEDAMPMTXT = "character",
                       TIMEARRIVEDTXT = "character",
                       TIMEARRIVEDAMPMTXT = "character",
                       INVESTCOMPLETEIND = "character",
                       PHOTOSTAKENIND = "character",
                       UNIQUELOCATIONID = "character",
                       STATEPROPIND = "character",
                       TRAFFICCNTRLCDE = "NULL",
                       TRAFFICCNTRLDESCR = "character",
                       UNITNMB = "numeric",
                       UNIT_VEHICLE_NUMBER = "numeric",
                       UNITTYPECDE = "NULL",
                       UNITTYPEDESCR = "character",
                       VEHYEARTXT = "numeric",
                       VEHMAKETXT = "character",
                       VEHMODELTXT = "character",
                       OCCUPSNMB = "numeric",
                       VEHLICSTATECDE = "character",
                       VEHLICSTATEDESCR = "NULL",
                       AXELSTXT = "numeric",
                       SPEEDLIMITTXT = "character",
                       TOWEDIND = "character",
                       VEHUSECDE = "NULL",
                       VEHUSEDESCR = "character",
                       ROADTYPECDE = "NULL",
                       ROADTYPEDESCR = "character",
                       TRAVDIRCDE = "character",
                       TRAVDIRDESCR = "NULL",
                       EMGERENCY_RUN = "character",
                       FIREIND = "character",
                       COLLEVENTCDE = "NULL",
                       COLLEVENTDESCR = "character",
                       PRECOLLACTCDE = "NULL",
                       PRECOLLACTDESCR = "character",
                       DISTRICT = "character",
                       DISTRICT_NUM = "NULL",
                       SUBDISTRICT = "character"
                       )
```

```{r}
setup_disk.frame()

# this will allow unlimited amount of data to be passed from worker to worker
options(future.globals.maxSize = Inf)

ARIES2007 <- csv_to_disk.frame(
    infile = "raw-ARIES/aries_crash_data_2007.csv",
    in_chunk_size = 500000,
    colClasses = columnParsing
)


head(ARIES2007, 1000)

```



